{"issue":{"title":"[CF 628] Addon does not start with combat - show only in combat ","body":" <p>Hi.<br>This report is from my warrior ,lvl 85, using TellMeWhen v.6.03. updated using Curse Installer.<br>I use the addon to show me when abilities are ready and to show me how long I have to use a reactive ability.<br>When out of combat the icons are hidden. During combat , the icons will show on screen. After combat ends, the icons once more disapear.<br>I have no problems with TellMeWhen v.6.0.2.<br>With 6.0.3, I started seeing a problem.<br>This is how I have been testing. I log into my warrior., I am already at the training dummies in Org. I charge a dummy.<br>with 6.0.2, the icons would now appear on screen showing cooldowns and abilities which are ready for use.<br>with 6.0.3, nothing happens. no icons appear during combat or after combat.<br>This will continue until I type /tmw which brings up config mode and then /tmw to enable use mode.<br>If I type this during combat or after combat , it has the same effect which is to enable the addon to work.</p><p>What version of TellMeWhen are you using? (\"The latest\" is not a version)</p><p>6.0.3 , R618alpha<br>installed using curse installer</p><p>Do you have an error log of what happened?</p><p>I have seen one error log show up, this was a script ran too long error.<br>I have not seen it since that one time during the many times I have tested.<br>I regret to say I didnt keep a copy of that log.</p><p>Please provide any additional information below (including any export strings if applicable; see above.)</p><p>^1^T^STextLayouts^T ^Sicon1^T ^N1^T ^t^N2^T ^t^t^t^SNumGroups^N10 ^SInterval^N0.05 ^SReceiveComm^b ^SVersion^N60409 ^SGroups^T ^N1^T ^SPoint^T ^Sy^F7593718780944622 ^f-46^Sx ^F-6744947538720944^f-46 ^t^SScale^F4959202241937407 ^f-52^SRows ^N3^SPrimarySpec ^b^SOnlyInCombat ^B^SColumns ^N7^SIcons ^T^N2^T ^SShowTimer^B ^SOnlyMine^B ^SType^Scooldown ^SShowTimerText^B ^SName^SBerserker~`Rage ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SEnabled^B ^t^N4^T ^SShowTimer^B ^SType^Sbuff ^SName^SBloodsurge ^SShowTimerText^B ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SEnabled^B ^t^N5^T ^SShowTimer^B ^SType^Scooldown ^SConditions^T ^N1^T ^SType^SHEALTH ^SUnit^Starget ^SOperator^S&lt; ^SLevel^N20 ^t^Sn^N1 ^t^SShowTimerText^B ^SManaCheck^B ^SName^SExecute ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SRangeCheck^B ^SEnabled^B ^t^N6^T ^SType^Scooldown ^SName^SPummel ^SManaCheck^B ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SConditions^T ^N1^T ^SType^SALIVE ^SUnit^Starget ^t^Sn^N1 ^t^SEnabled^B ^SRangeCheck^B ^t^N9^T ^SShowTimer^B ^SType^Scooldown ^SShowTimerText^B ^SManaCheck^B ^SName^SBloodthirst ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SRangeCheck^B ^SEnabled^B ^t^N10^T ^SShowTimer^B ^SType^Sreactive ^SName^SRaging~`Blow;~`Raging~`Blow! ^SManaCheck^B ^SShowTimerText^B ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SRangeCheck^B ^SEnabled^B ^t^N11^T ^SType^Scooldown ^SConditions^T ^N1^T ^SType^SICON ^SIcon^STellMeWhen_Group1_Icon4 ^t^Sn^N1 ^t^SName^SSlam ^SManaCheck^B ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SEnabled^B ^t^N12^T ^SShowTimer^B ^SType^Scooldown ^SConditions^T ^N1^T ^SType^SALIVE ^SUnit^Starget ^t^Sn^N1 ^t^SShowTimerText^B ^SManaCheck^B ^SName^SColossus~`Smash ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SRangeCheck^B ^SEnabled^B ^t^N13^T ^SShowTimer^B ^SOnlyMine^B ^SType^Sbuff ^SShowTimerText^B ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SShowWhen^N1 ^SName^SBattle~`Shout ^SEnabled^B ^t^N14^T ^SShowTimer^B ^SType^Sreactive ^SShowTimerText^B ^SName^SVictory~`Rush ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SRangeCheck^B ^SEnabled^B ^t^N15^T ^SType^Scooldown ^SName^S100 ^SSettingsPerView^T ^Sicon^T ^STexts^T ^N1^S ^t^t^t^SEnabled^B ^SRangeCheck^B ^t^N16^T ^SType^Sbuff ^SName^SBloodsurge ^SCustomTex^S100130 ^SEnabled^B ^t^N18^T ^SShowTimer^B ^SType^Scooldown ^SShowTimerText^B ^SName^S118000 ^SEnabled^B ^t^t^t^N2^T ^SPoint^T ^Sy^F4646201076914912 ^f-45^Sx ^F-8184997534261907^f-46 ^t^SScale^F4708952728300740 ^f-52^SRows ^N3^SEnabled ^B^SSecondarySpec ^b^SIcons ^T^N1^T ^SType^Scooldown ^SName^S100 ^SRangeCheck^B ^SEnabled^B ^t^N2^T ^SType^Scooldown ^SName^S6544 ^SEnabled^B ^t^N13^T ^SType^Scooldown ^SName^S34428 ^SEnabled^B ^t^N7^T ^SType^Scooldown ^SName^S6673 ^SEnabled^B ^t^N15^T ^SType^Scooldown ^SName^S12294 ^SEnabled^B ^t^N9^T ^SType^Scooldown ^SName^S6552 ^SEnabled^B ^t^N5^T ^SType^Scooldown ^SName^S18499 ^SEnabled^B ^t^N19^T ^SType^Scooldown ^SName^S118000 ^SEnabled^B ^t^N11^T ^SType^Scooldown ^SName^S86346 ^SEnabled^B ^t^N21^T ^SType^Scooldown ^SName^S5308 ^SEnabled^B ^t^N18^T ^SType^Sreactive ^SName^S1464 ^SEnabled^B ^t^N17^T ^SType^Sreactive ^SName^S7384 ^SEnabled^B ^t^t^SColumns^N7 ^t^N3^T ^SPoint^T ^Sy^N-110 ^Sx^N100 ^Spoint^STOPLEFT ^SrelativePoint^STOPLEFT ^t^t^N4^T ^SPoint^T ^Sy^N-140 ^Sx^N100 ^Spoint^STOPLEFT ^SrelativePoint^STOPLEFT ^t^t^N5^T ^SPoint^T ^Sy^N-170 ^Sx^N100 ^Spoint^STOPLEFT ^SrelativePoint^STOPLEFT ^t^t^N6^T ^SPoint^T ^Sy^N-200 ^Sx^N100 ^Spoint^STOPLEFT ^SrelativePoint^STOPLEFT ^t^t^N7^T ^SPoint^T ^Sy^N-230 ^Sx^N100 ^Spoint^STOPLEFT ^SrelativePoint^STOPLEFT ^t^t^N8^T ^SPoint^T ^Sy^N-260 ^Sx^N100 ^Spoint^STOPLEFT ^SrelativePoint^STOPLEFT ^t^t^N9^T ^SPoint^T ^Sy^N-290 ^Sx^N100 ^Spoint^STOPLEFT ^SrelativePoint^STOPLEFT ^t^t^N10^T ^SPoint^T ^Sy^N-320 ^Sx^N100 ^Spoint^STOPLEFT ^SrelativePoint^STOPLEFT ^t^t^t^SWarnInvalids^B ^t^N60409^S~`~| ^Sprofile^SRedemption~`-~`Turalyon ^^</p> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/desademarquis\">desademarquis</a> | Imported from CurseForge issue <a href=\"https://wow.curseforge.com/projects/tellmewhen/issues/628\">#628</a> | <a href=\"https://github.com/tmw-issue-import/dump/blob/master/html/628.html\">Raw</a>","closed":true,"closed_at":"2012-10-12T06:25:56Z","created_at":"2012-09-17T22:28:07Z","updated_at":"2012-10-12T06:25:56Z","labels":["defect","resolved"]},"comments":[{"body":" <p>was testing again today and had an lua error...</p>\r\n<p>Message: ...e\\AddOns\\Blizzard_DebugTools\\Blizzard_DebugTools.lua:536: script ran too long\r\nTime: 09/19/12 00:44:53\r\nCount: 1\r\nStack: ...e\\AddOns\\Blizzard_DebugTools\\Blizzard_DebugTools.lua:536: in function `ScriptErrorsFrame_OnError'\r\n[string \"Interface\\FrameXML\\BasicControls.xml:&lt;Scrip...\"]:18: in function &lt;[string \"Interface\\FrameXML\\BasicControls.xml:&lt;Scrip...\"]:4&gt;\r\n[C]: ?\r\nInterface\\AddOns\\TellMeWhen\\TellMeWhen.lua:2768: in function `LoadOptions'\r\nInterface\\AddOns\\TellMeWhen\\TellMeWhen.lua:1960: in function &lt;Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:1953&gt;</p>\r\n<p>Locals: message = \"Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:2768: script ran too long\"\r\nkeepHidden = nil\r\nstack = \"Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:2768: in function `LoadOptions'\r\nInterface\\AddOns\\TellMeWhen\\TellMeWhen.lua:1960: in function &lt;Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:1953&gt;\r\n\"\r\nmessageStack = \"Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:2768: script ran too longInterface\\AddOns\\TellMeWhen\\TellMeWhen.lua:2768: in function `LoadOptions'\r\nInterface\\AddOns\\TellMeWhen\\TellMeWhen.lua:1960: in function &lt;Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:1953&gt;\r\n\"\r\nindex = 1\r\n(*temporary) = &lt;table&gt; {\r\n}\r\n(*temporary) = \"self = TMW { 0 = &lt;userdata&gt; OnGCD = &lt;function&gt; defined @Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:2816 Vararg = &lt;function&gt; defined @Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:618 SlashCommand = &lt;function&gt; defined @Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:5657 modules = &lt;table&gt; { } CancelTimer = &lt;function&gt; defined @Interface\\AddOns\\DataStore\\libs\\AceTimer-3.0\\AceTimer-3.0.lua:311 ReconcileData = &lt;function&gt; defined @Interface\\AddOns\\TellMeWhen\\Options\\TellMeWhen_Options.lua:367 GetBaseUpgrades = &lt;function&gt; defined @Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:2042 GCDSpell = 5308 DeserializeData = &lt;function&gt; defined @Interface\\AddOns\\TellMeWhen\\Options\\TellMeWhen_Options.lua:3109 InNLengthTable = &lt;function&gt; defined @Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:453 Group_HasIconData = &lt;function&gt; defined @Interface\\AddOns\\TellMeWhen\\Options\\TellMeWhen_Options.lua:1385 InIconSettings = &lt;function&gt; defined @Interface\\AddOns\\TellMeWhen\\TellMeWhen.lua:499 SetDefaultModulePrototype = &lt;fun(*temporary) = 4\r\n(*temporary) = \"script ran too long\"\r\n_ScriptErrorsFrame = ScriptErrorsFrame { 0 = &lt;userdata&gt; messages = &lt;table&gt; { } close = &lt;unnamed&gt; { } previous = &lt;unnamed&gt; { } indexLabel = &lt;unnamed&gt; { } locals = &lt;table&gt; { } title = &lt;unnamed&gt; { } times = &lt;table&gt; { } seen = &lt;table&gt; { } count = &lt;table&gt; { } order = &lt;table&gt; { } next = &lt;unnamed&gt; { }\r\n}</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/desademarquis\">desademarquis</a>","created_at":"2012-09-18T23:47:32Z"},{"body":" <p>Works perfectly fine for me. When in my secondary spec (so that group 1, the only group you have set to show while in combat, will show), the group shows and hides as needed when entering and leaving combat.</p>\r\n<p>Group 2 shows all the time while in my primary spec (as intended, since you don't have it set to show while only in combat.)</p>\r\n<p>Is what I just described not the behavior that you desire? Or is it not working for you in this way?</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/Cybeloras\">Cybeloras</a>","created_at":"2012-09-19T19:12:01Z"},{"body":" <p>My seconday spec is Fury, primary is Arms.\r\nFor some reason I have always had Arms set to always show icons (in combat and out of combat ) and Fury to always Hide whilst out of combat.\r\nI have been testing in Fury spec and get the same problem each time , in that the icons remain hidden when in combat unless I type /tmw and then /tmw to exit config mode.\r\nMaybe I have a saved variable thats wrong.\r\nHow can I fully uninstall TMW and yet retain all the icon settings I have made?\r\nI have 20x 85s so you can imagine I have spent some time making up sets for each one.\r\nThanks for your help </p> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"09 19 2012 15:25:04 (CST) (UTC-5:00)\" data-epoch=\"1348086304\">Sep 19, 2012</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/desademarquis\">desademarquis</a>","created_at":"2012-09-19T20:25:04Z"},{"body":" <p>Nevermind. It seems that I am able to reproduce the issue only with all other addons except TellMeWhen disabled.</p> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"09 19 2012 16:44:15 (CST) (UTC-5:00)\" data-epoch=\"1348091055\">Sep 19, 2012</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/Cybeloras\">Cybeloras</a>","created_at":"2012-09-19T21:38:32Z"},{"body":" <p>Try r622</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/Cybeloras\">Cybeloras</a>","created_at":"2012-09-19T23:28:18Z"},{"body":" <p>r622 works.</p>\r\n<p>Icons remain hidden until combat starts. once combat ends, they go back to hidden.\r\nThank you very much.</p>\r\n<p>can I ask where the problem was? laymans terms please</p>\r\n<p>Thanks again <span>:)</span></p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/desademarquis\">desademarquis</a>","created_at":"2012-09-19T23:55:52Z"},{"body":" <p>The Only In Combat group option actually gets turned into a group condition internally. When a group's conditions are being setup, they are loaded into a condition constructor object - just a bunch of code that takes condition settings and turns them into condition objects that are used throughout TMW. They also ensure that no duplicate condition objects are made - if you have 10 icons with identical conditions, only one condition object is created for maximum performance.</p>\r\n<p>When the Only in Combat group setting is seen, the condition object constructor creates a copy of the group's original condition settings that can be modified internally without actually modifying the settings that you see. Then, it tacks on a Unit in Combat condition, and then constructs the condition object.</p>\r\n<p>The problem is that the condition object constructors also took some steps to ensure minimal memory usage. The internally cloned copy of settings was reused over and over again, which previously was fine because all conditions (icon, group, and unit conditions) used the same default settings.</p>\r\n<p>In TMW 6.0.3, unit conditions began using a slightly modified version of the normal condition default settings. The problem happens when a condition constructor is created and then loads unit conditions as its very first conditions. The base of the internally modifiable conditions then became the defaults used for unit conditions instead of the ones used for normal conditions, so when it came time to construct the conditions for group 1, the default unit for the condition appended internally to handle the Only In Group setting used \"unit\" as its unit instead of \"player\".</p>\r\n<p>Obviously, \"unit\" isn't the correct unitID (it isn't even valid at all and is used specially for unit conditions) for checking if you are in combat.</p>\r\n<p>The problem was actually fixed in two places. One is that unit sets no longer attempt to construct conditions when they don't have any. The other, and the main fix for this issue (the first fix would only work if you didn't use any unit conditions for any of your icons) is that condition constructors no longer attempt to reuse the base for their internally modifiable conditions. A new one is generated every time a new unit condition set is needed or every time a group is updated or configured (regular icon conditions never used these internally modifiable conditions, so they were immune to this whole issue). The side effect of this is that more memory is used each time you lock/unlock TMW or configure certain parts, but the extra garbage churn will get gobbled up by Lua's garbage collector the next time that it runs.</p>\r\n<p>The reason that I was originally unable to reproduce the issue is that when you are using Masque, TMW runs its initial setup an extra time when you log in in order to get everything skinned properly (Masque is really buggy with TMW and I don't know why). This is basically the equivalent to unlocking and locking TMW after you logged in to get things working again. The second update was (and I don't know why) constructing a correct condition object for the group (using unit \"player\" instead of unit \"unit\").</p>\r\n<p>Not quite layman's terms, but it is hard to explain the most complicated feature in TMW with simple terms. =P</p> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"09 19 2012 19:41:41 (CST) (UTC-5:00)\" data-epoch=\"1348101701\">Sep 19, 2012</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/Cybeloras\">Cybeloras</a>","created_at":"2012-09-20T00:38:00Z"}]}