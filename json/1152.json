{"issue":{"title":"[CF 1152] Putting lua in tmw?? ","body":" <p>I am trying to make a meta icon that tells me which spell will cause the most dps/sp if cast, starfire or wrath.</p>\r\n<p>I made this in my addons folder</p>\r\n<p><code>&lt;&lt;<span>quote</span><span></span>&gt;&gt;</code>local sfgeneral = function ()<br>\tname, rank, icon, castTime, minRange, maxRange, spellID = GetSpellInfo(2912);<br>\tsfcasttime = castTime*.001;\t<br>\r\nend</p>\r\n<p>sfgeneral();</p>\r\n<p>local wgeneral = function ()<br>\tname, rank, icon, castTime, minRange, maxRange, spellID = GetSpellInfo(5176);<br>\twcasttime = castTime*.001;\t<br>\r\nend</p>\r\n<p>wgeneral();</p>\r\n<p>local currentee = function () <br>\tcpower= UnitPower(\"player\", 8);<br>\r\nend</p>\r\n<p>currentee();</p>\r\n<p>local eclipsedir = function()<br>\tedirection = GetEclipseDirection();<br>\r\nend</p>\r\n<p>local sffemoon = function()<br>\teclipsedir()<br>\tif edirection == \"sun\" then sffem = (math.max(-100,math.min(100,-105*math.sin(math.pi - math.asin(cpower/105) + math.pi/10 * sfcasttime))));<br>\telseif edirection == \"moon\" then sffem = (math.max(-100,math.min(100,-105*math.sin(math.asin(cpower/105) + math.pi/10 * sfcasttime))));<br>\telse sffem = (math.max(-100,math.min(100,-105*math.sin(math.asin(cpower/105) + math.pi/10 * sfcasttime))));<br>\tend<br>\r\nend</p>\r\n<p>sffemoon();</p>\r\n<p>local wfemoon = function()<br>\teclipsedir()<br>\tif edirection == \"sun\" then wfem = (math.max(-100,math.min(100,-105*math.sin(math.pi - math.asin(cpower/105) + math.pi/10 * wcasttime))));<br>\telseif edirection == \"moon\" then wfem = (math.max(-100,math.min(100,-105*math.sin(math.asin(cpower/105) + math.pi/10 * wcasttime))));<br>\telse wfem = (math.max(-100,math.min(100,-105*math.sin(math.asin(cpower/105) + math.pi/10 * wcasttime))));<br>\tend<br>\r\nend</p>\r\n<p>wfemoon ();</p>\r\n<p>local masbonus = function()<br>\tgetmas= GetMasteryEffect()+30;<br>\tgethas= GetHaste();<br>\r\nend</p>\r\n<p>masbonus();</p>\r\n<p>local sfdamage = function()<br>\tsfdmg=224.6*(1+(((-1*(sffem))+100)/2/100*getmas)/100);<br>\r\nend</p>\r\n<p>sfdamage();</p>\r\n<p>local wdamage = function()<br>\twdmg=140.4*(1+(((wfem)+100)/2/100*getmas)/100);<br>\r\nend</p>\r\n<p>wdamage();</p>\r\n<p>&lt;&lt;/quote&gt;&gt;</p>\r\n<p>If i </p>\r\n<p>print (sfdmg)</p>\r\n<p>print (wdmg)</p>\r\n<p>it gives me the disired results. But i have no idea how to take this and use it in tmw with a sfdmg&gt;wdmg condition</p>\r\n<p>I added the above code into the global snippets which causes no error </p>\r\n<p>i added sfdmg&gt;wdmg as a condition to my icon</p>\r\n<p>but the icon is always displayed even if sfgmg&lt;=wdmg</p> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/AxeDamage\">AxeDamage</a> | Imported from CurseForge issue <a href=\"https://wow.curseforge.com/projects/tellmewhen/issues/1152\">#1152</a> | <a href=\"https://github.com/tmw-issue-import/dump/blob/master/html/1152.html\">Raw</a>","closed":true,"closed_at":"2015-09-14T23:49:02Z","created_at":"2015-08-22T11:14:05Z","updated_at":"2015-09-14T23:49:02Z","labels":["defect","invalid"]},"comments":[{"body":" <p>Please post the export strings of the icon and snippet that you are having trouble with.</p> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"08 22 2015 11:56:50 (CST) (UTC-5:00)\" data-epoch=\"1440262610\">Aug 22, 2015</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/Cybeloras\">Cybeloras</a>","created_at":"2015-08-22T16:55:33Z"},{"body":" <p>thanks for answering </p>\r\n<p>you rock</p>\r\n<div>\n\n```\n&lt;&lt;code ^1^T^SType^Sconditionicon ^SConditions^T ^N1^T ^SType^SLUA ^SName^Ssforwrath(sfdamage)&gt;sforwrath(wdamage) ^t^Sn^N1 ^t^SCustomTex^S2912 ^SEnabled^B ^t^N73501^S~`~| ^Sicon^^&gt;&gt;\r\n\r\n&lt;&lt;/code&gt;&gt;\r\n\r\n&lt;&lt;code ^1^T^SName^SSfOrWrath ^SCode^S~J function~`TMW.CNDT.Env.sforwrath()~J ~`~`~`local~`sfgeneral~`=~`function~`()~J ~`~`~`~`name,~`rank,~`icon,~`castTime,~`minRange,~`maxRange,~`spellID~`=~`GetSpellInfo(2912);~J ~`~`~`~`sfcasttime~`=~`castTime*.001;~`~`~`~`~J end~J ~J sfgeneral();~J ~J local~`wgeneral~`=~`function~`()~J ~`~`~`~`name,~`rank,~`icon,~`castTime,~`minRange,~`maxRange,~`spellID~`=~`GetSpellInfo(5176);~J ~`~`~`~`wcasttime~`=~`castTime*.001;~`~`~`~`~J end~J ~J wgeneral();~J ~J local~`currentee~`=~`function~`()~`~J ~`~`~`~`cpower=~`UnitPower(\"player\",~`8);~J end~J ~J currentee();~J ~J local~`eclipsedir~`=~`function()~J ~`~`~`~`edirection~`=~`GetEclipseDirection();~J end~J ~J local~`sffemoon~`=~`function()~J ~`~`~`~`eclipsedir()~J ~`~`~`~`if~`edirection~`==~`\"moon\"~`then~`sffem~`=~`(math.max(-100,math.min(100,105*math.sin(math.pi~`-~`math.asin(cpower/105)~`+~`math.pi/10~`*~`sfcasttime))));~J ~`~`~`~`elseif~`edirection~`==~`\"sun\"~`then~`sffem~`=~`(math.max(-100,math.min(100,105*math.sin(math.asin(cpower/105)~`+~`math.pi/10~`*~`sfcasttime))));~J ~`~`~`~`else~`sffem~`=~`(math.max(-100,math.min(100,105*math.sin(math.pi~`-~`math.asin(cpower/105)~`+~`math.pi/10~`*~`sfcasttime))));~J ~`~`~`~`end~J end~J ~J sffemoon();~J ~J local~`wfemoon~`=~`function()~J ~`~`~`~`eclipsedir()~J ~`~`~`~`if~`edirection~`==~`\"moon\"~`then~`wfem~`=~`(math.max(-100,math.min(100,105*math.sin(math.pi~`-~`math.asin(cpower/105)~`+~`math.pi/10~`*~`wcasttime))));~J ~`~`~`~`elseif~`edirection~`==~`\"sun\"~`then~`wfem~`=~`(math.max(-100,math.min(100,105*math.sin(math.asin(cpower/105)~`+~`math.pi/10~`*~`wcasttime))));~J ~`~`~`~`else~`wfem~`=~`(math.max(-100,math.min(100,105*math.sin(math.pi~`-~`math.asin(cpower/105)~`+~`math.pi/10~`*~`wcasttime))));~J ~`~`~`~`end~J end~J ~J wfemoon~`();~J ~J local~`masbonus~`=~`function()~J ~`~`~`~`getmas=~`GetMasteryEffect()+30;~J ~`~`~`~`gethas=~`GetHaste();~J end~J ~J masbonus();~J ~J local~`sfdamage~`=~`function()~J ~`~`~`sfdmg=224.6*(1+(((-1*(sffem))+100)/2/100*getmas)/100)/sfcasttime;~J return~`sfdmg;~J end~J ~J sfdamage();~J ~J local~`wdamage~`=~`function()~J ~`~`~`wdmg=140.4*(1+(((wfem)+100)/2/100*getmas)/100)/wcasttime;~J return~`wdmg;~J end~J wdamage~`();~J print(sfdmg);~J end ^t^N73501^S~`~| ^Scodesnippet^^&gt;&gt;\r\n\r\n&lt;&lt;/code&gt;&gt;\n```\n</div><div>\n\n```\n&lt;&lt;code ^1^T^SName^SSfOrWrath ^SCode^S~J function~`TMW.CNDT.Env.sforwrath()~J ~`~`~`local~`sfgeneral~`=~`function~`()~J ~`~`~`~`name,~`rank,~`icon,~`castTime,~`minRange,~`maxRange,~`spellID~`=~`GetSpellInfo(2912);~J ~`~`~`~`sfcasttime~`=~`castTime*.001;~`~`~`~`~J end~J ~J sfgeneral();~J ~J local~`wgeneral~`=~`function~`()~J ~`~`~`~`name,~`rank,~`icon,~`castTime,~`minRange,~`maxRange,~`spellID~`=~`GetSpellInfo(5176);~J ~`~`~`~`wcasttime~`=~`castTime*.001;~`~`~`~`~J end~J ~J wgeneral();~J ~J local~`currentee~`=~`function~`()~`~J ~`~`~`~`cpower=~`UnitPower(\"player\",~`8);~J end~J ~J currentee();~J ~J local~`eclipsedir~`=~`function()~J ~`~`~`~`edirection~`=~`GetEclipseDirection();~J end~J ~J local~`sffemoon~`=~`function()~J ~`~`~`~`eclipsedir()~J ~`~`~`~`if~`edirection~`==~`\"moon\"~`then~`sffem~`=~`(math.max(-100,math.min(100,105*math.sin(math.pi~`-~`math.asin(cpower/105)~`+~`math.pi/10~`*~`sfcasttime))));~J ~`~`~`~`elseif~`edirection~`==~`\"sun\"~`then~`sffem~`=~`(math.max(-100,math.min(100,105*math.sin(math.asin(cpower/105)~`+~`math.pi/10~`*~`sfcasttime))));~J ~`~`~`~`else~`sffem~`=~`(math.max(-100,math.min(100,105*math.sin(math.pi~`-~`math.asin(cpower/105)~`+~`math.pi/10~`*~`sfcasttime))));~J ~`~`~`~`end~J end~J ~J sffemoon();~J ~J local~`wfemoon~`=~`function()~J ~`~`~`~`eclipsedir()~J ~`~`~`~`if~`edirection~`==~`\"moon\"~`then~`wfem~`=~`(math.max(-100,math.min(100,105*math.sin(math.pi~`-~`math.asin(cpower/105)~`+~`math.pi/10~`*~`wcasttime))));~J ~`~`~`~`elseif~`edirection~`==~`\"sun\"~`then~`wfem~`=~`(math.max(-100,math.min(100,105*math.sin(math.asin(cpower/105)~`+~`math.pi/10~`*~`wcasttime))));~J ~`~`~`~`else~`wfem~`=~`(math.max(-100,math.min(100,105*math.sin(math.pi~`-~`math.asin(cpower/105)~`+~`math.pi/10~`*~`wcasttime))));~J ~`~`~`~`end~J end~J ~J wfemoon~`();~J ~J local~`masbonus~`=~`function()~J ~`~`~`~`getmas=~`GetMasteryEffect()+30;~J ~`~`~`~`gethas=~`GetHaste();~J end~J ~J masbonus();~J ~J local~`sfdamage~`=~`function()~J ~`~`~`sfdmg=224.6*(1+(((-1*(sffem))+100)/2/100*getmas)/100)/sfcasttime;~J return~`sfdmg;~J end~J ~J sfdamage();~J ~J local~`wdamage~`=~`function()~J ~`~`~`wdmg=140.4*(1+(((wfem)+100)/2/100*getmas)/100)/wcasttime;~J return~`wdmg;~J end~J wdamage~`();~J print(sfdmg);~J end ^t^N73501^S~`~| ^Scodesnippet^^&gt;&gt;\r\n\r\n&lt;&lt;/code&gt;&gt;\n```\n</div> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/AxeDamage\">AxeDamage</a>","created_at":"2015-08-22T19:40:33Z"},{"body":" <p>Your code is severely flawed.</p>\r\n<ul><li><code>sforwrath</code> is defined as a function that takes no parameters, yet you pass it one in both places where you call it.\r\n</li><li>The arguments that you do pass in those locations are undefined.\r\n</li><li>There are two variables with the same name as those undefined arguments defined within that function, but they are local to that function and thus cannot be referenced outside of it.\r\n</li><li>You compare the return values of both function calls, but <code>sforwrath</code> doesn't return anything\r\n</li><li><code>sforwrath</code> creates 9 functions every time it is called. In the case of Lua conditions on an icon, this is as fast as your update interval, which by default is 16 times per second. This is going to create a massive amount of memory churn. Furthermore, those functions are only ever called one time after they are defined, so there is no reason for them to be functions in the first place.\r\n</li><li>The following variables are all leaked globals, which is just bad practice in general, and may cause issues with your code's functionality: <code>sfdmg, spellID, maxRange, minRange, castTime, icon, rank, name, sfcasttime, wcasttime, cpower, edirection, sffem, wfem, getmas, gethas, wdmg</code>\r\n</li></ul> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"08 22 2015 14:58:31 (CST) (UTC-5:00)\" data-epoch=\"1440273511\">Aug 22, 2015</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/Cybeloras\">Cybeloras</a>","created_at":"2015-08-22T19:58:09Z"},{"body":" <p>Thanks for the help</p>\r\n<p>I only started coding 3 days ago and this is my first attempt</p>\r\n<p>\"sforwrath is defined as a function that takes no parameters, yet you pass it one in both places where you call it.\"</p>\r\n<p>In the condition?</p>\r\n<p>This sounds stupid but can you tell me the solutions to the problems you have pointed out?</p>\r\n<p>as a general structure how should the snippet and the condition be?</p>\r\n<p>sorry for the hassle, i have spent days on this and am a bit lost as to how it should be done</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/AxeDamage\">AxeDamage</a>","created_at":"2015-08-22T20:28:32Z"},{"body":" <p>Here is the function:</p>\r\n<div><div><div>\n\n```\nfunction TMW.CNDT.Env.GetBalanceSpellDPS(spellID, baseDamage)\r\n\r\n\tlocal _, _, _, castTime = GetSpellInfo(spellID)\r\n\tcastTime = castTime / 1000\r\n\t\r\n\tlocal cpower = UnitPower(\"player\", 8)\r\n\tlocal edirection = GetEclipseDirection()\r\n\tlocal mastery = GetMasteryEffect() + 30\r\n\r\n\r\n\tlocal fem\r\n\tif edirection == \"sun\" then\r\n\t\tfem = math.asin(cpower/105) + math.pi/10 * castTime\r\n\telse\r\n\t\tfem = math.pi - math.asin(cpower/105) + math.pi/10 * castTime\r\n\tend\r\n\tfem = math.max(-100, math.min(100, 105*math.sin(fem)))\r\n\r\n\treturn baseDamage*(1+(((fem)+100)/2/100*mastery)/100)/castTime\r\nend\r\n\n```\n</div></div>\r\n</div><p>Here's the code for the Lua condition:</p>\r\n<div><div><div>\n\n```\nGetBalanceSpellDPS(5176, 140.4) &gt; GetBalanceSpellDPS(2912, 224.6)\r\n\n```\n</div></div>\r\n</div> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"08 26 2015 02:24:22 (CST) (UTC-5:00)\" data-epoch=\"1440573862\">Aug 26, 2015</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/Cybeloras\">Cybeloras</a>","created_at":"2015-08-26T00:35:16Z"}]}