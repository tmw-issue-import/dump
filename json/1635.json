{"issue":{"title":"[CF 1635] Doesn't work check for pet spells in range ","body":" <p>I want to check DK's pet Jump spell for in range condition. I tried \"Icon\" tab with Spell Cooldown type and \"Conditions\" tab with spell in range, nothing don't work. I searched some info and found that&nbsp;IsSpellInRange function has stop work since 7.2 patch, seems like truth coz I can't receive through /dump true statement but I found that action bar slot still works for that. Is any way to make check pet spell for in range?</p> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/cordankos\">cordankos</a> | Imported from CurseForge issue <a href=\"https://wow.curseforge.com/projects/tellmewhen/issues/1635\">#1635</a> | <a href=\"https://github.com/tmw-issue-import/dump/blob/master/html/1635.html\">Raw</a>","closed":true,"closed_at":"2018-12-24T23:26:16Z","created_at":"2018-12-17T17:58:03Z","updated_at":"2018-12-24T23:26:16Z","labels":["question","cantfix"]},"comments":[{"body":" <p>First:&nbsp; from your Spellbook's Pet tab, drag \"Leap\" (from here on out I'm assuming that's what you mean by Jump spell) to one of your action bars.</p>\r\n<p>&nbsp;</p>\r\n<p>Import the following custom lua snippet:</p>\r\n<p>&nbsp;</p>\r\n<div>\n\n```\n^1^T^SName^SLeapInRance ^SCode^Sfunction~`GetActionSlot(id)~J ~`~`~`~`local~`id~`=~`id~J ~`~`~`~`for~`i=1,~`72~`do~J ~`~`~`~`~`~`~`~`if~`select(2,~`GetActionInfo(i))~`==~`id~`then~J ~`~`~`~`~`~`~`~`~`~`~`~`return~`i~J ~`~`~`~`~`~`~`~`end~J ~`~`~`~`end~J end~J ~J leapslot~`=~`GetActionSlot(47482)~J if~`not~`leapslot~`then~J ~`~`~`~`leapslot~`=~`GetActionSlot(91809)~J end~J ~J ~J function~`IsLeapInRange(unit)~J ~`~`~`~`if~`not~`leapslot~`then~J ~`~`~`~`~`~`~`~`return~`false~J ~`~`~`~`end~J ~`~`~`~`if~`not~`unit~`then~J ~`~`~`~`~`~`~`~`unit~`=~`\"target\"~J ~`~`~`~`end~J ~`~`~`~`return~`UnitExists(unit)~`and~`IsActionInRange(leapslot,unit)~J end~J ~J ~J ~J ~J ^t^N85702^S~`~| ^Scodesnippet^^\n```\n</div>\r\n<p>&nbsp;</p>\r\n<p>&nbsp;</p>\r\n<p>For your icon's condition, create a Miscellaneous &gt; \"Lua (advanced)\" condition and put IsLeapInRange() in the textbox.</p>\r\n<p>Here's an example group with such an icon you can import and look at:</p>\r\n<div>\n\n```\n^1^T^SGUID^STMW:group:1S63h0liB99r ^SScale^F6380114325536771 ^f-51^SPoint ^T^Sy^F8469066696097792 ^f-47^Spoint ^SBOTTOM^SrelativePoint ^SBOTTOM^Sx ^F-5339729237517724^f-46 ^t^SColumns^N1 ^SIcons^T ^N1^T ^SType^Sconditionicon ^SConditions^T ^N1^T ^SType^SLUA ^SName^SIsLeapInRange() ^t^Sn^N1 ^t^SSettingsPerView^T ^Sicon^T ^STextLayout^Sicon1 ^STexts^T ^N1^SLeap ^N2^S ^t^t^t^SCustomTex^S47482 ^SStates^T ^N1^T ^t^N3^T ^t^N4^T ^t^t^SEnabled^B ^t^N2^T ^SStates^T ^N1^T ^t^N3^T ^t^N4^T ^t^t^t^N3^T ^SStates^T ^N1^T ^t^N3^T ^t^N4^T ^t^t^t^N4^T ^SStates^T ^N1^T ^t^N3^T ^t^N4^T ^t^t^t^t^t^N85702^S~`~| ^Sgroup^N1 ^^\n```\n</div>\r\n<p>&nbsp;</p> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"12 17 2018 19:41:01 (CST) (UTC-6:00)\" data-epoch=\"1545097261\">Dec 17, 2018</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/canofbutter\">canofbutter</a>","created_at":"2018-12-18T00:13:30Z"},{"body":" <p>Thanks for reply, actually its heavy load cpu with huge fps drop to query each slot so I did it by cache through events UNIT_PET and ACTIONBAR_SLOT_CHANGED, idea is same, so sadly that I saw this too late.&nbsp;</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/cordankos\">cordankos</a>","created_at":"2018-12-18T01:52:28Z"},{"body":" <p>It doesn't check every cycle.&nbsp; It only has to check every slot once when the snippet first loads.&nbsp; (the downside to having done that means if you move Leap to a different slot, you'll have to rerun the snippet or /reload)&nbsp; Read the code again - you'll see that's how it works.</p> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"12 18 2018 08:18:49 (CST) (UTC-6:00)\" data-epoch=\"1545142729\">Dec 18, 2018</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/canofbutter\">canofbutter</a>","created_at":"2018-12-18T14:17:43Z"},{"body":" <p>Here you go - I spent a little more time on this for you so you can freely move Leap around on your action bars without reloading:</p>\r\n<p>&nbsp;</p>\r\n<div>\n\n```\n^1^T^SName^SLeapInRange ^SCode^Sfunction~`GetActionSlot(id)~J ~`~`~`~`local~`id~`=~`id~J ~`~`~`~`for~`i=1,~`72~`do~J ~`~`~`~`~`~`~`~`if~`select(2,~`GetActionInfo(i))~`==~`id~`then~J ~`~`~`~`~`~`~`~`~`~`~`~`return~`i~J ~`~`~`~`~`~`~`~`end~J ~`~`~`~`end~J end~J ~J local~`leapslot~`=~`GetActionSlot(47482)~J if~`not~`leapslot~`then~J ~`~`~`~`leapslot~`=~`GetActionSlot(91809)~J end~J ~J ~J local~`leapf~`=~`CreateFrame(\"FRAME\");~J ~J leapf:RegisterEvent(\"ACTIONBAR_SLOT_CHANGED\");~J ~J function~`LeapButtonHandler(self,~`event,~`...)~J ~`~`~`~`leapslot~`=~`GetActionSlot(47482)~J ~`~`~`~`if~`not~`leapslot~`then~J ~`~`~`~`~`~`~`~`leapslot~`=~`GetActionSlot(91809)~J ~`~`~`~`end~J end~J ~J leapf:SetScript(\"OnEvent\",~`LeapButtonHandler);~J ~J ~J ~J function~`IsLeapInRange(unit)~J ~`~`~`~`if~`not~`leapslot~`then~J ~`~`~`~`~`~`~`~`return~`false~J ~`~`~`~`end~J ~`~`~`~`if~`not~`unit~`then~J ~`~`~`~`~`~`~`~`unit~`=~`\"target\"~J ~`~`~`~`end~J ~`~`~`~`return~`UnitExists(unit)~`and~`IsActionInRange(leapslot,unit)~J end~J ~J ~J ~J ~J ~J ~J ^t^N85702^S~`~| ^Scodesnippet^^\n```\n</div>\r\n<p>&nbsp;</p>\r\n<p>For convenience of reviewing it, here's the full code of the snippet without the import string encoding:</p>\r\n<div>\n\n```\nfunction GetActionSlot(id)\r\n    local id = id\r\n    for i=1, 72 do\r\n        if select(2, GetActionInfo(i)) == id then\r\n            return i\r\n        end\r\n    end\r\nend\r\n\r\nlocal leapslot = GetActionSlot(47482)\r\nif not leapslot then\r\n    leapslot = GetActionSlot(91809)\r\nend\r\n\r\n\r\nlocal leapf = CreateFrame(\"FRAME\");\r\n\r\nleapf:RegisterEvent(\"ACTIONBAR_SLOT_CHANGED\");\r\n\r\nfunction LeapButtonHandler(self, event, ...)\r\n    leapslot = GetActionSlot(47482)\r\n    if not leapslot then\r\n        leapslot = GetActionSlot(91809)\r\n    end\r\nend\r\n\r\nleapf:SetScript(\"OnEvent\", LeapButtonHandler);\r\n\r\n\r\n\r\nfunction IsLeapInRange(unit)\r\n    if not leapslot then\r\n        return false\r\n    end\r\n    if not unit then\r\n        unit = \"target\"\r\n    end\r\n    return UnitExists(unit) and IsActionInRange(leapslot,unit)\r\nend\n```\n</div>\r\n<p>&nbsp;</p>\r\n<p>As you can see, the function that scans all action bar slots is only called on load and on the action bar event - not every update.&nbsp; IsLeapInRange uses the already scanned for \"leapslot\" variable in calling IsActionInRange; it does not continuously call GetActionSlot.</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/canofbutter\">canofbutter</a>","created_at":"2018-12-18T15:42:35Z"},{"body":" <p>I have around same code. In your code you still have weak in cpu performance because&nbsp;ACTIONBAR_SLOT_CHANGED trigers on anything, if you have macro with modifiers then it will triger event and again call&nbsp;GetActionSlot several times while you playing since slot changing by macro. Also more better will be add time stamp to stop triger event several times at same time rate. And even if you triger&nbsp;ACTIONBAR_SLOT_CHANGED then in arg1 it return slot which has been changed, so you can compare it with&nbsp;leapslot variable as well which make you more performance.&nbsp;UnitExists(unit) in&nbsp;IsLeapInRange can be removed since&nbsp;IsActionInRange always return nil if target is not valid, better \"return&nbsp;IsActionInRange(leapslot,unit) or false\". Wow has 120 max buttons to check, I don't here a lot why need use 72 if possible make all 120. True ID always is&nbsp;47482 for Jump, no need use&nbsp;91809, or it can be checked by locale name compare through GetSpellInfo.&nbsp;</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/cordankos\">cordankos</a>","created_at":"2018-12-18T23:28:41Z"},{"body":" <p><a href=\"https://wow.gamepedia.com/Action_slot\" rel=\"nofollow\">https://wow.gamepedia.com/Action_slot</a></p>\r\n<p>Really only makes sense to check 72 at most.</p>\r\n<p>&nbsp;</p>\r\n<p>The operation to scan them is very fast and not heavy on the CPU. Such a small, short, simple loop is likely not slower than any cache lookups - also I wasn't aware of any action bar caching; what do you mean by this?</p>\r\n<p>No real reason for time stamping or the like - even with heavy macro usage it won't fire all that frequently (no more so than maybe once or twice per modifier keypress at most).&nbsp; I messed around with this a bit and in the worst case got it to fire maybe 3 times per second if I was absolutely mad about smashing modifiers.</p>\r\n<p>UnitExists is a leftover from other checks I was doing (that I removed for this) in addition to IsActionInRange that actually needed it - feel free to remove it.</p>\r\n<p>&nbsp;</p>\r\n<p>If you feel you have a better answer to your own question, I don't see why you're not sharing it.&nbsp; Other people might benefit that are trying to do the same/similar things...</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/canofbutter\">canofbutter</a>","created_at":"2018-12-19T00:30:00Z"},{"body":" <div>\n\n```\nfunction GetActionSlot(id)\r\n    local id = id\r\n    for i=1, 72 do\r\n        actionType, actionid, subType = GetActionInfo(i)\r\n        if subType == \"pet\" and actionid == id then\r\n            return i\r\n        end\r\n    end\r\n   message(\"Leap is not found\")\r\nend\r\n\r\nlocal leapslot, timestamp = GetActionSlot(47482), TMW.time\r\n\r\nlocal leapf = CreateFrame(\"FRAME\")\r\nleapf:RegisterEvent(\"ACTIONBAR_SLOT_CHANGED\")\r\nfunction LeapButtonHandler(self, event, ...)\r\n    if PetHasActionBar() and TMW.time ~= timestamp and (not leapslot or leapslot == ...)  then\r\n        timestamp = TMW.time\r\n        leapslot = GetActionSlot(47482)\r\n    end\r\nend\r\n\r\nleapf:SetScript(\"OnEvent\", LeapButtonHandler)\r\n\r\nfunction IsLeapInRange()\r\n    return (leapslot and IsActionInRange(leapslot)) or false\r\nend\n```\n</div>\r\n<p>&nbsp;</p>\r\n<p>&nbsp;</p>\r\n<p>&nbsp;</p>\r\n<p>I don't have a lot of powerfull pc and I see game spikes when query slots through ACTIONBAR_SLOT_CHANGED. Function&nbsp;IsActionInRange has only one argument to use, its slot without unit, you can check slot in range for \"focus\" if there exist macro with @focus.</p> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"12 18 2018 19:18:52 (CST) (UTC-6:00)\" data-epoch=\"1545182332\">Dec 18, 2018</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/cordankos\">cordankos</a>","created_at":"2018-12-19T01:12:21Z"},{"body":" <p>Default TMW must have this feature. Would be interest in theory somehow create hidden button to use it for query action.</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/cordankos\">cordankos</a>","created_at":"2018-12-19T01:16:43Z"},{"body":" <p>Still not seeing anything one would call \"caching\" related to the action bar.&nbsp; Also, I don't think you intended to assign the slot location to \"timestamp\", that wouldn't really mean anything.</p>\r\n<p>&nbsp;</p>\r\n<p>If you're using a ton of macro modifiers it would fire a lot, I suppose.&nbsp; For a test I filled all 6 of my action bars with macros that had modifiers.&nbsp; Even using my code without the timestamp check, it scanned them all repeatedly like that in around 1/8000th of a second.&nbsp; Try as I might, I just can't see your frame drops coming from that, but there's no reason not to do the timestamp check as you did, so that's fine.</p>\r\n<p>&nbsp;</p>\r\n<p>As for your change in GetActionSlot - you don't need to check the subtype for pet - spell ids are unique</p>\r\n<p>IsActionInRange can indeed take a unit - API documentation you're finding must be out of date.&nbsp; I rely on this a lot when checking units by nameplate.</p>\r\n<p>&nbsp;</p>\r\n<p>Regardless, if you're really trying to squeeze out everything you can performance wise, skip all the event handling entirely and use the original I posted - it'll only ever scan when you load in or /reload - can't get better than that and it's what I use for all pet range checking - here's that code block:</p>\r\n<div>\n\n```\nfunction GetActionSlot(id)\r\n    for i=1, 72 do\r\n        if select(2, GetActionInfo(i)) == id then\r\n            return i\r\n        end\r\n    end\r\nend\r\n-- this only runs once on load/reload, so do a /reload if you move the button\r\nlocal leapslot = GetActionSlot(47482)\r\n\r\nfunction IsLeapInRange(unit)\r\n    if not leapslot then\r\n        return false\r\n    end\r\n    if not unit then\r\n        unit = \"target\"\r\n    end\r\n    return IsActionInRange(leapslot,unit) or false\r\nend\r\n\r\n\n```\n</div>\r\n<p>As for any sort of hidden buttons, no not really:&nbsp; IsActionInRange accepts action bar slots from the base game only.&nbsp; Any new, hidden action buttons you create could not be passed to it.</p> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"12 18 2018 20:05:11 (CST) (UTC-6:00)\" data-epoch=\"1545185111\">Dec 18, 2018</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/canofbutter\">canofbutter</a>","created_at":"2018-12-19T01:54:26Z"},{"body":" <p>I remade your code which you sent first time because as you noticed in last message&nbsp;&nbsp;</p>\r\n<blockquote>\r\n<p>If you're using a ton of macro modifiers it would fire a lot, I suppose</p>\r\n</blockquote>\r\n<div>\n\n```\nfunction LeapButtonHandler(self, event, ...)\r\n    leapslot = GetActionSlot(47482) -- here is each Alt Ctrl Shift will fire this event and query slots which will make for me game spikes\r\n    if not leapslot then\r\n        leapslot = GetActionSlot(91809)\r\n    end\r\nend\r\n\r\n\n```\n</div>\r\n<p>So better use:</p>\r\n<blockquote>\r\n<p>if PetHasActionBar() and TMW.time ~= timestamp and (not leapslot or leapslot == ...) then&nbsp;&nbsp;</p>\r\n</blockquote>\r\n<p>Cache also means that, don't query slots if we know that Leap already here or saved LeapSlot has been changed in current fired slot.</p>\r\n<p>&nbsp;</p>\r\n<p>OMG IsActionInRange second argument for me is big suprise, because I checked wowpedia and wowwiki, they are both telling only 1 argument. Where you looking actual API for that?</p> <div class=\"project-issue-comment-body-modified\"> <hr> <span class=\"e-infoLabel\">Edited</span><span> <abbr class=\"tip standard-date standard-datetime\" title=\"12 18 2018 20:27:17 (CST) (UTC-6:00)\" data-epoch=\"1545186437\">Dec 18, 2018</abbr></span> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/cordankos\">cordankos</a>","created_at":"2018-12-19T02:21:20Z"},{"body":" <p><a href=\"https://wow.gamepedia.com/Patch_2.0.1/API_changes#API_Changes:_Information\" rel=\"nofollow\">https://wow.gamepedia.com/Patch_2.0.1/API_changes#API_Changes:_Information</a></p>\r\n<p>Been available since 2.0.1 - works 100% - use it all the time</p>\r\n<p>Also, no, the code that I sent the first time (the import string) didn't have any event handling at all - it was a single run on load.&nbsp; We're over complicating this to handle what is really just an edge case:&nbsp; moving the button around without relying on a /reload.&nbsp; That's just unnecessary and the original snippet import string (not the readable code block - my very first reply had import strings) is more then sufficient.&nbsp;&nbsp; I never should have tried adding that bit, as it just seems to be leading to confusion and possible performance issues.</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/canofbutter\">canofbutter</a>","created_at":"2018-12-19T02:28:54Z"},{"body":" <p>Oh, and the cache thing you're mentioning:&nbsp; that's EXACTLY what the first reply's import snippet did.&nbsp; You just with apparent misunderstanding about how TMW's snippets worked (they don't run constantly - they're run once).&nbsp; Using a LUA condition and actually calling IsLeapInRange() is the only thing that will run repeatedly, and that's using the action bar location of your pet's ability that was found on the snippets initial first run and never gets rescanned by that function.</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/canofbutter\">canofbutter</a>","created_at":"2018-12-19T02:32:20Z"},{"body":" <p>Oh yea, it was 3rd msg. I guess for people who will search any solution will fair enough everything here. Well this thing is very usefully for range class with pet though nameplates. Thanks&nbsp;<span><a href=\"https://wow.curseforge.com/members/canofbutter\" rel=\"nofollow\">canofbutter</a></span>&nbsp;</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/cordankos\">cordankos</a>","created_at":"2018-12-19T02:39:44Z"},{"body":" <p>It does seem that&nbsp;IsSpellInRange does indeed not work for pet spells anymore. I don't plan on implementing any workarounds in TMW to do actionbar scanning - Blizzards needs to get their stuff together and fix their API. Unforunately, as a general rule of thumb, Blizzard couldn't care less about any of their API as long as it isn't broken in a way that affects the default UI.</p> <div class=\"project-issue-comment-body-modified\"> </div> \n<br>\n\n> Posted by CurseForge user <a href=\"https://wow.curseforge.com/members/Cybeloras\">Cybeloras</a>","created_at":"2018-12-24T23:24:33Z"}]}